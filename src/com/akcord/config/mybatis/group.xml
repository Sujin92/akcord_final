<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">  
<mapper namespace="com.akcord.group.dao.GroupDao">
    
    <insert id="createG" parameterType="groupRoomDto">
        insert all 
        into grouproom
        (group_id, major_id, group_name, content, leader_id, reg_date, g_count)
        values (seq_group_id.nextval, #{majorId}, #{groupName}, #{content}, #{leaderId},
        sysdate, #{gCount})
        into grouproom_list
        (group_id, user_id, is_accept, reg_date) values (seq_group_id.currval, #{leaderId}, 1, sysdate)
         select * from dual
    </insert>
    
    <select id="grouplist" parameterType="String" resultType="groupRoomDto">
        select (select count(group_id) from grouproom_list gl where gl.group_id = g.group_id and gl.is_accept = 1) nowCount, g.group_id groupId, g.reg_date as regDate, m.major_name majorName, g.group_name groupName,
               g.content content, g.g_count gCount, u.name name from users u, grouproom g, major m
               where u.user_id = g.leader_id and
               g.major_id = m.major_id
               and g.leader_id != #{myseq}
               order by g.reg_date desc
    </select>
    
    <select id="waitinglist" parameterType="int" resultType="groupRoomDto">
        select gl.reg_date waitingDate, m.major_name majorName, g.group_name groupName, g.content content, u.name name,
                g.group_id groupId
                from grouproom_list gl, grouproom g, major m, users u
                where g.major_id = m.major_id
                and gl.group_id = g.group_id
                and g.leader_id = u.user_id
                and gl.user_id = #{userId}
                and g.leader_id != #{userId}
                and gl.is_accept = 0
    </select>
    
    <select id="majorlist" resultType="com.akcord.group.model.MajorDto">
        select major_id majorId, major_name majorName
        from major
    </select>
    
    <insert id="joinGroup" parameterType="String">
        insert into grouproom_list values (#{seq}, #{userId}, 0,sysdate)
    </insert>
    
    <delete id="cancel" parameterType="String">
        delete grouproom_list where group_id = #{seq}
               and is_accept = 0
    </delete>
    
    
</mapper>